version: 0.2

env:
  variables:
    REPORT_BUCKET: "arjit-grype-report-s3"   # S3 bucket for HTML report

phases:
  install:
    runtime-versions:
      nodejs: 16
      python: 3.9
    commands:
      - echo "üîß Installing dependencies..."
      - npm install
      - echo "‚¨áÔ∏è Installing Grype vulnerability scanner..."
      - curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
      - grype version
      - echo "‚úÖ Grype installed successfully."

  pre_build:
    commands:
      - echo "=========================================="
      - echo "üîç Step 1: Running vulnerability scan with Grype"
      - echo "=========================================="

      # Run Grype and create JSON report
      - grype dir:. --output json > grype-report.json || true

      - echo "üìÅ Checking if JSON report exists..."
      - |
        if [ ! -f "grype-report.json" ]; then
          echo "‚ùå grype-report.json not found ‚Äî scan failed!"
          exit 1
        else
          echo "‚úÖ grype-report.json generated successfully."
        fi

      - echo "=========================================="
      - echo "üßæ Step 2: Converting JSON report to HTML"
      - echo "=========================================="

      # Ensure Python script exists before running
      - |
        if [ ! -f "grype_to_html.py" ]; then
          echo "‚ùå grype_to_html.py not found in the source directory!"
          exit 1
        fi

      # Run Python script to generate HTML report
      - python3 grype_to_html.py

      - echo "=========================================="
      - echo "üì§ Step 3: Uploading HTML report to S3 bucket"
      - echo "=========================================="

      # Upload HTML report to S3 bucket
      - |
        if [ -f "grype-report.html" ]; then
          aws s3 cp grype-report.html s3://$REPORT_BUCKET/
          echo "‚úÖ HTML report uploaded to s3://$REPORT_BUCKET/"
        else
          echo "‚ùå grype-report.html not found ‚Äî skipping upload!"
          exit 1
        fi

  build:
    commands:
      - echo "‚úÖ Grype scan and HTML report generation completed successfully."

artifacts:
  files:
    - grype-report.html
